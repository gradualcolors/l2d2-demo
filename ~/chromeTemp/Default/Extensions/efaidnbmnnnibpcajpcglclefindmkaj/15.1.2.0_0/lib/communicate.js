/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
function dependOn(){"use strict";return[require("util"),require("common"),require("analytics"),require("proxy")]}var def;require=function(e){"use strict";return e},def=window.define?window.define:function(e,s){"use strict";return s.apply(null,[{ajax:$.ajax.bind($)}])};var exports=acom_analytics={};def(dependOn(),(function(e,s,t,i){"use strict";var n,o,r=null,a={};for(n in r||(r=new function(){var n={},r={};this.proxy=i.proxy.bind(this),this.LOG=s.LOG,this.registerHandlers=function(s){e.extend(n,s)},this.registerModule=function(e,s){a[e]=s},this.getModule=function(e){return a[e]},this.reset=function(e,i){s.reset(e.environment),t.setAnalyticsUsage(e.analytics_on,i.tab.id),e.environment&&(t.environment=e.environment,t.event(t.e.OPTIONS_SET_ENV))},this.updateVisibility=function(e){1==e.received_limits&&1==e.received_signedin&&1==e.received_display&&0==e.signed_in&&1==e.has_free_ops&&(e.panel_op="external-msg-response",e.data={valid:"true"},this.sendMessage(e),e.frame_visibility="visible",e.content_op="none",e.panel_op="load-frictionless",this.sendMessage(e),e.received_limits=null,e.received_signedin=null,e.signed_in=null,e.has_free_ops=null,e.received_display=null)},this.externalMsgHandler=function(s,i,n){let o=s.data,a=r[i.tab.id];if("signed_in"===o.content_op)a.received_signedin=!0,"search"===a.frictionless_workflow&&(a.signed_in=o.is_signed_in,1==a.signed_in?(a.content_op="dismiss",this.sendMessage(a)):this.updateVisibility(a));else if("limits"===o.content_op){if(a.received_limits=!0,"search"===a.frictionless_workflow)if(o.limits&&a.pdf_action){a.has_free_ops=this.hasFreeOperations(a.pdf_action,o.limits),this.updateVisibility(a);let e=a.pdf_action?a.pdf_action.toUpperCase().replace(/\-/g,"_"):"UNKNOWN";t.event(t.e.FRICTIONLESS_WIDGET_LOADED,{TOOL:e})}else a.content_op="dismiss",this.sendMessage(a)}else if("complete_conversion"===o.content_op)e.createTab(o.conversion_url),a&&(a.content_op="dismiss",this.sendMessage(a));else if(o.dc_hosted_event){let e=o.dc_hosted_event;switch(e.event){case"pre-processing-error":case"processing-error":if(e.event_data){let s=e.event_data.title,t=e.event_data.description;a&&(a.error_title=s,a.error_description=t,a.content_op="none",a.panel_op="show-frictionless-error",this.sendMessage(a))}break;case"file-upload-start":a&&(a.panel_op="clear-frictionless-error",this.sendMessage(a));break;case"dropzone-displayed":a&&(a.received_display=!0,"trefoil"===a.frictionless_workflow?(a.panel_op="load-frictionless",a.hide_spinner=!0,a.content_op="none",this.sendMessage(a),a.hide_spinner=null):"search"===a.frictionless_workflow&&this.updateVisibility(a));break;case"startup-error":{a&&("search"===a.frictionless_workflow?(a.content_op="dismiss",this.sendMessage(a)):"trefoil"===a.frictionless_workflow&&(a.panel_op="load-frictionless",a.hide_spinner=!0,a.content_op="none",this.sendMessage(a),a.hide_spinner=null));let e=a.pdf_action?a.pdf_action.toUpperCase().replace(/\-/g,"_"):"UNKNOWN";t.event(t.e.FRICTIONLESS_WIDGET_STARTUP_ERROR,{TOOL:e});break}}}},this.registerHandlers({reset:this.proxy(this.reset),external_msg:this.proxy(this.externalMsgHandler)}),this.version=-1,this.legacyShim=function(){return this.version<=1},this.setVersion=function(e){this.version=e},this.resetPersistPrefCount=function(){e.setCookie("persist-menu-closed",0,3650)},this.incrementPersistPrefCount=function(){var s=e.getCookie("persist-menu-closed");s<10&&"false"!==e.getCookie("always-show-pdf-menu")&&(s++,e.setCookie("persist-menu-closed",s,3650)),s>=10&&(e.setCookie("always-show-pdf-menu","false",3650),t.event(t.e.PERSIST_PDF_OPENPDF_PREF_OFF))},this.isEnablePersistMenu=function(){return"false"!==e.getCookie("always-show-pdf-menu")&&(e.getCookie("persist-menu-closed")<10?!this.legacyShim():"true"===e.getCookie("always-show-pdf-menu")&&(this.resetPersistPrefCount(),!0))},this.hasFreeOperations=function(e,s){let t=null;switch(e){case"word-to-pdf":case"ppt-to-pdf":case"jpg-to-pdf":case"excel-to-pdf":case"createpdf":t="create_pdf";break;case"compress-pdf":t="compress_pdf"}let i=s[t];return i&&i.can_process||!1},this.handler=function(i,a,l){var d;if(i&&(this.dump(i,"Communicate Handler receive: "),a&&a.tab&&(i.tabId=a.tab.id,o||(o=a.tab.id),i.main_op))){if("analytics"==i.main_op)return delete i.main_op,void t.logBrowserAnalytics(i);if(r[i.tabId]&&r[i.tabId].suppress_frictionless&&(i.suppress_frictionless=r[i.tabId].suppress_frictionless),"third-party-cookies"==i.main_op)return this.version!==SETTINGS.READER_VER&&0!==this.version&&1!==this.version||i.cookies_status||(SETTINGS.FRICTIONLESS_ENABLED=!1,this.version===SETTINGS.READER_VER&&this.avoidUrl(a.tab.url)?this.disable(i.tabId):0===this.version||this.version),delete i.main_op,void delete i.status;if("relay_to_content"===i.main_op)return 1==i.newUI&&"dismiss"===i.content_op?(i.persist=!1,null!=i.tabId&&(r[i.tabId].persist=!1),this.incrementPersistPrefCount()):1==i.newUI&&"pdf_menu"===i.panel_op&&(this.isEnablePersistMenu()?null!=i.tabId&&(r[i.tabId].persist=!0):i.persist=!1,this.resetPersistPrefCount()),delete i.main_op,t.logBrowserAnalytics(i),void this.sendMessage(i);if("get-frictionless-url"===i.main_op)return delete i.main_op,i.frictionless_uri=s.getFrictionlessUri(),i.env=s.getEnv(),i.panel_op="load-frictionless",this.sendMessage(i),void t.logBrowserAnalytics(i);if(t.logBrowserAnalytics(i),d=i.main_op,delete i.main_op,"dismiss"===d&&this.closeDialog(),i.version=this.version,n[d])return t.setOp({preview:"Copy",image_preview:"Image",send:"Send",fillsign:"FillSign",export:"Export",acom:"GotoAcom",to_pdf:"ConvertToPdf"}[i.handleResult]),n[d](i,a,l);e.consoleLog("failed to find handler for: "+d)}},this.closeDialog=function(){e.isFF()&&this.globals.panel.hide()},this.echoRequest=function(s){var i,n,o;if(SETTINGS.CHROME_VERSION<SETTINGS.SUPPORTED_VERSION)this.getModule("session").newSession("data/js/options.html",!0,{});else{if(!this.avoidUrl(s.url)){if(e.isFF())i=this.lastRequest||{panel_op:"html_menu"};else{var a=s.id||s.tabId;if(r[a]){if("cancelled"!==(i=r[a]).current_status&&"pdf_opened"!==i.current_status&&"pdf_failure"!==i.current_status||(o=i.is_pdf,this.clearStatus(i),i.is_pdf=o),i.current_status&&(i.panel_op="status"),this,!SETTINGS.TEST_MODE&&"mac"===SETTINGS.OS)return void this.getModule("session").newSession("data/js/options.html?os=mac",!0,{});n=i.is_pdf?"pdf_menu":"html_menu",i.panel_op&&"load-frictionless"===i.panel_op&&(delete i.panel_op,t.event(t.e.FRICTIONLESS_WIDGET_CLOSED)),"resize_window"===i.content_op&&(delete i.content_op,delete i.window_height),i.panel_op=i.panel_op||n,"html_menu"===n&&(i.persist=!1),e.consoleLog("repeat cached request: "+i.panel_op)}}return i}this.disable(s.id)}},this.echo=function(e){t.event(t.e.TREFOIL_CLICKED);var s=this.echoRequest(e);s&&("search"===s.frictionless_workflow&&(s.suppress_frictionless=!0),s.trefoilClick=!0,s.frictionless_workflow=null,s.frame_visibility=null,s.persist=this.isEnablePersistMenu(),this.sendMessage(s))},this.setGlobals=function(e){this.globals=e},this.dump=function(s,t){var i,n=[t];for(i in s)s.hasOwnProperty(i)&&n.push("  "+i+": "+s[i]);e.consoleLog(n.join("\n"))},this.sendMessage=function(s){var i,n=s.tabId;this.dump(s,"Sending message:"),s.version=this.version,r[n]=e.extend(r[n],s),e.showFrictionlessMenu(s)&&(s.show_frictionless=!0),"pdf_menu"===s.panel_op&&(s.trefoilClick?i=t.e.TREFOIL_PDF_FROM_CLICK:0==s.persist&&(i=t.e.TREFOIL_PDF_MENU_SHOWN)),"flickr"===s.panel_op&&(i=t.e.FLICKR_OFFER_SHOWN),"html_menu"===s.panel_op&&(i=t.e.TREFOIL_HTML_FROM_CLICK),i&&t.checkAndLogAnalytics(i),e.sendMessage(s,this.globals),delete s.trefoilClick},this.deferMessage=function(e){"undefined"==typeof setTimeout?this.sendMessage(e):setTimeout(this.proxy(this.sendMessage,e),0)},this.filenameFromUrl=function(e){var s=decodeURIComponent(e),t=(s=(s=s.split("?")[0].replace(/\S*\//,"")).replace(/[\?]\S*/,"")).split("/");return-1==(s=t[t.length-1]).toLowerCase().indexOf(".pdf")&&(s+=".pdf"),s},this.pdf_menu=function(s,i){var n;"mac"!==SETTINGS.OS&&((n=r[i.tab.id]=e.extend(r[i.tab.id],{tabId:i.tab.id})).filename=this.filenameFromUrl(s.url),n.panel_op="pdf_menu",n.url=s.url,n.is_pdf=!0,n.isFillnSignEnabled=SETTINGS.FILL_N_SIGN_ENABLED,1==s.persist&&this.isEnablePersistMenu()?n.persist=!0:n.persist=!1,"false"!==e.getCookie("always-show-pdf-menu")&&(1==n.persist&&t.event(t.e.PERSIST_PDF_MENU_SHOWN),this.deferMessage(n)))},this.loaded=function(s){r[s]=e.extend(r[s],{tabId:s,loaded:!0}),this.enable(s)},this.clearStatus=function(e,s){"in_progress"!==e.current_status&&"downloading"!==e.current_status&&(s||"waiting"!==e.current_status)&&(this.getModule("acro-web2pdf").cancelConversion(e.tabId),delete e.current_status,delete e.file_path,delete e.domtitle,delete e.timing,delete e.panel_op,delete e.is_pdf,delete e.trefoilUI,delete e.newUI)},this.loading=function(s){var t=s.id;r[t]=e.extend(r[t],{tabId:t,loaded:!1}),this.clearStatus(r[t],!0),this.enable(t)},this.active=function(s){if(o=s.tabId,r[o]=e.extend(r[o],{tabId:s.tabId}),this.isEnablePersistMenu()){var t=this.echoRequest(r[o]);t&&t.persist&&this.sendMessage(t)}},this.enable=function(e){var s=r[e].loaded?"data/images/acrobat_dc_appicon_24.png":"data/images/acrobat_dc_appicon_24_translucent.png";chrome.browserAction.setIcon({path:s,tabId:e}),r[e].loaded?chrome.browserAction.enable(e):chrome.browserAction.disable(e)},this.disable=function(e){r[e]&&(r[e].loaded=!1,this.enable(e))},this.close=function(e){this.getModule("acro-web2pdf").cancelConversion(e),delete r[e],o===e&&(o=null)},this.tabReplace=function(e,s){this.close(s),this.loaded(e)},this.activeTab=function(){return o},this.noop=function(){},this.avoidUrl=function(e){if(e=e||"",this.version===SETTINGS.ERP_READER_VER)return!0;if(e.startsWith("https://chrome.google.com"))return!0;if(this.version==SETTINGS.READER_VER&&0==SETTINGS.FRICTIONLESS_ENABLED)return!e.endsWith(".pdf")&&!e.endsWith(".PDF");if((0==this.version||1==this.version)&&!1===SETTINGS.FRICTIONLESS_ENABLED)return!1;return 0==chrome.i18n.getMessage("@@ui_locale").startsWith("en")?!e.endsWith(".pdf")&&!e.endsWith(".PDF"):!e.startsWith("http")}},e.isChrome()&&(chrome.runtime.onMessage.addListener(r.proxy(r.handler)),chrome.tabs.onActivated.addListener(r.proxy(r.active)),chrome.tabs.onRemoved.addListener(r.proxy(r.close)),chrome.tabs.onCreated.addListener(r.proxy(r.loading)),chrome.tabs.onReplaced.addListener(r.proxy(r.tabReplace)))),r)r.hasOwnProperty(n)&&("function"==typeof r[n]?exports[n]=r[n].bind(r):exports[n]=r[n]);return r.registerHandlers({"send-analytics":r.proxy(r.noop)}),r}));