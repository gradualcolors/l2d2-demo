/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
function dependOn(){"use strict";return[require("util"),require("common"),require("proxy"),require("communicate"),require("analytics")]}var def;require=function(e){"use strict";return e},def=window.define?window.define:function(e,t){"use strict";return t.apply(null,[{ajax:$.ajax.bind($)}])};var exports=acom_analytics={};def(dependOn(),(function(e,t,r,i,n){"use strict";var s,o,a=null;for(s in function(){return i.getModule("upload")},o=function(){return i.getModule("convert-to-zip")},a||(a=new function(){var i,s,a;this.proxy=r.proxy.bind(this),this.LOG=t.LOG,this.updateName=function(i,n){if(!i||!n)return e.Deferred().resolve().promise();var s=t.settings.files_api+"assets/"+i+"/metadata/name",o=JSON.stringify({value:n,on_dup_name:"auto_rename"});return e.ajax({type:"PUT",url:s,data:o,headers:t.POST_headers()}).then((function(){}),this.proxy((function(e){r.REST_error(e,this,{url:s,data:o})})))},this.updateParent=function(i,n){if(!i||!n)return e.Deferred().resolve().promise();var s=t.settings.files_api+"assets/"+a.assetId+"/metadata/parent_id",o=JSON.stringify({value:n,on_dup_name:"auto_rename"});return e.ajax({type:"PUT",url:s,data:o,headers:t.POST_headers()}).then((function(){}),this.proxy((function(e){r.REST_error(e,this,{url:s,data:o})})))},this.rename=function(t){var r=e.Deferred();return this.updateName(t.assetId,t.filename).then(this.proxy((function(){this.updateParent(t.assetId,t.dest_folder).then((function(){r.resolve()}),(function(){r.reject()}))})),(function(){r.reject()})),r.promise()},this.gotoPath=function(r){var i=e.Deferred();a.userSelectPromise?a.userSelectPromise.then((function(){i.resolve()}),(function(){i.reject()})):i.resolve(),i.then(this.proxy((function(){t.sso_url(r).then(this.proxy((function(t){s?(e.isChrome()&&chrome.tabs.update(s,{url:t.uri,active:!0}),s=null):e.createTab(t.uri)})),this.proxy((function(i){r=t.settings.cloud_host+r,s?(e.isChrome()&&chrome.tabs.update(s,{url:r,active:!0}),s=null):e.createTab(r)})))})))},this.file_spec_done=function(e){a.dest_folder=e.dest_folder;var t=a.filename;"zip"!==t.substring(t.length-3,t.length)&&(a.filename=e.filename),a.upload_promise.then(this.proxy((function(){this.rename(a).then((function(){a.userSelectPromise.resolve()}),(function(){a.userSelectPromise.reject()}))})))},this.message=function(t,r,i){s&&e.sendMessage({tabId:s,progress_op:i?"set-error":"set-text",text:t,busy:r})},this.foundCode=function(e){var r=e.split("?")[1].split("=")[1].split("&")[0];this.newSession(null,!0),n.event(n.e.SIGN_IN_COMPLETE),t.authorize(r).then((function(){i&&i.resolve(),i=null}),(function(){i&&i.reject(),i=null}))},this.sessionRequest=function(e,t){(a=e).params=t||{filename:a.filename}},this.send_folders=function(){this.signed_in().then(this.proxy((function(){n.event(n.e.UPLOAD_RENAME_CLICKED),e.ajax({type:"POST",headers:t.POST_headers(),url:t.settings.files_api+"search",data:JSON.stringify({q:{object_type:"folder"},metadata:["id","name","created","parent_id"]})}).then(this.proxy((function(r){s&&(r.results.push({parent_id:null,object_type:"root",created:"2015-03-31T11:37:40",id:t.settings.files_root,name:"/"}),e.sendMessage({tabId:s,progress_op:"folders",folders:r.results}))})),this.proxy((function(e,t,i){r.REST_error(e,this)})))})))},this.newSession=function(t,r,i){i||(i=a.params),i.filename&&(a.userSelectPromise=e.Deferred()),t||(e.isChrome()&&(t=chrome.runtime.getURL("data/js/progress.html")+"#"+e.param(i)),i.filename&&this.send_folders()),s?e.isChrome()&&chrome.tabs.update(s,{url:t,active:!0}):(e.isChrome()&&chrome.tabs.create({url:t},this.proxy((function(e){r&&(s=e.id)}))),e.isFF()&&require("sdk/windows").browserWindows.open({url:t}))},this.sign_in=function(r,s){return i&&(i.reject(),i=null,n.event(n.e.SIGN_IN_ABANDONED)),i=e.Deferred(),t.baseUris().then(this.proxy((function(){var r={client_id:t.settings.ims_client_id,redirect_uri:t.settings.redirect_uri,scope:"AdobeID, skybox, openid",dc:!1},i=t.settings.ims_host+"ims/authorize/v1?"+e.param(r);n.event(n.e.SIGN_IN_SHOWN),this.newSession(i,!0)}))),i.promise()},this.signed_in=function(){return i||e.Deferred().resolve().promise()},this.signOut=function(){e.isChrome()&&chrome.tabs.create({url:t.settings.ims_host+"ims/logout/v1?"+e.param({access_token:t.settings.auth_token.replace(/Bearer /,""),client_id:t.settings.ims_client_id,client_secret:t.settings.ims_client_secret,redirect_uri:"https://adobe.com"})}),t.clearAuth()},this.checkSessionTab=function(e,t){e===s&&-1===t.indexOf("chrome-extension:")&&-1===t.indexOf(".adobe.com/")&&(s=null,i&&(i.reject(),i=null,n.event(n.e.SIGN_IN_ABANDONED)))},this.getFrictionlessURL=function(){var t="";return e&&e.getTranslation&&(t=e.getTranslation("web2pdfFrictionlessUrl")),""===t&&(t="https://www.adobe.com/go/fl_chromeext"),t},this.getAonlineURL=function(){return"https://www.adobe.com/acrobat/online.html"},this.goto_acom=function(t){SETTINGS.USE_ACROBAT?e.createTab(this.getFrictionlessURL()):(this.sessionRequest(t,{}),this.gotoPath("files"))},this.go_to_aonline=function(t){e.createTab(this.getAonlineURL())},this.html_to_pdf=function(t,r){t.filename=r.tab.title.replace(/[\*"\/\\'&\.]/g,"")+".pdf",this.sessionRequest(t,{filename:t.filename,message:"Gathering HTML Content",busy:"true",progress_op:"htmlToPdf"}),this.sign_in(t,r).then(this.proxy((function(){e.isChrome()&&chrome.tabs.executeScript(t.tabId,{code:"var maxSize= "+SETTINGS.MAX_HTML_SIZE+", DEBUG = "+SETTINGS.DEBUG_MODE+", TABID = "+t.tabId+", OP = 'html-blob', EXCLUDE = [];",allFrames:!0},(function(){chrome.tabs.executeScript(t.tabId,{file:"data/js/get-html.js",allFrames:!0})}))})))},this.relay_message=function(t){t.complete?t.error?(e.consoleLog(t.error),n.event(n.e.HTML_SOURCE_SIZE_TOO_LARGE_ERROR)):(t.html_op="serialize_iframe",e.isChrome()&&chrome.tabs.executeScript(t.tabId,{code:"if (window.dc && window.OP) { receiveIframe("+JSON.stringify(t)+"); }",allFrames:!0})):e.isChrome()&&chrome.tabs.executeScript(t.tabId,{code:"if (window.dc && window.OP) {serialize("+JSON.stringify(t)+"); }",allFrames:!0})},this.flickr=function(e){this.sessionRequest(e,{}),this.newSession(null,!1,{unavailable:"flickr"})},this.error=function(t){if(s){a&&a.userSelectPromise&&a.userSelectPromise.reject();var r=["Please Report this Error:"];e.each(t,(function(e,t){r.push(e+": "+t)})),this.message(r.join("\n"),!1,!0),s=null}},r.handlers(this.error.bind(this)),e.isChrome()&&chrome.tabs.onRemoved.addListener((function(e){e===s&&(s=null,i&&(n.event(n.e.SIGN_IN_ABANDONED),i.reject(),i=null))})),this.html_blob=function(t){if(t.error)e.consoleError(t.error),n.logError(t.error,t.analytics[0]);else{n.logContents(t),n.checkAndLogHTMLBlobSize(t.blob.currentSize/1048576),t.analytics&&n.setParamsAndLogAnalytics(t.analytics,n.e.HTML_SOURCE_CONTENT,"content"),n.setArg("stage","CLONE"),n.checkAndLogTimingRange(t.cloneTiming),e.consoleLog("html blob send to:"+s);var r=JSON.stringify(t.blob);o().compress(r,a)}}},i.registerHandlers({goto_acom:a.proxy(a.goto_acom),go_to_aonline:a.proxy(a.go_to_aonline),html_to_pdf:a.proxy(a.html_to_pdf),flickr:a.proxy(a.flickr),file_spec_done:a.proxy(a.file_spec_done),"html-blob":a.proxy(a.html_blob),"relay-msg":a.proxy(a.relay_message)}),i.registerModule("session",a)),a)a.hasOwnProperty(s)&&("function"==typeof a[s]?exports[s]=a[s].bind(a):exports[s]=a[s]);return a}));